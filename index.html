<!DOCTYPE html>

<html>

    <head>
        <meta charset="utf-8">
        <style>*{background-color:rgb(116, 116, 116)}</style>
    </head>

    <body>
        <canvas id='canva' width=1000 height=1000 style="background-color:rgb(0, 0, 80); margin:auto; display: block;"></canvas>

        <script>
            window.addEventListener('contextmenu', event => event.preventDefault(),false);
            let canvas = document.getElementById('canva');
            let ctx = canvas.getContext('2d');

            const screenCfg = {
                screenSize: 250,
                pixelSize: 2,

                calculatePixelSize() { this.pixelSize = (canvas.height+canvas.width)/2/this.screenSize },
                setScreenSize(size) {
                    this.screenSize = size;
                    this.calculatePixelSize();
                },

                calculateScreenSize() { this.screenSize = (canvas.height+canvas.width)/2/this.pixelSize },
                setPixelSize(size) {
                    this.pixelSize = size;
                    this.calculateScreenSize();
                }
            };
            screenCfg.calculatePixelSize();

            const CES = {
                showTitle: true,
                inputValue:'',
                _enabled: true,
                print(x,y,text,color='#ffffff',nlindent=0) {
                    let l = ""+Math.random();
                    let ret = {
                        text,
                        destroy: function() {
                            delete CES.printBuffer[this.key];
                            return undefined;
                        },
                        x,y,baseColor:color,nlindent,
                        key:l
                    }
                    this.printBuffer[l] = ret;
                    return ret;
                },
                clearPrints() {
                    for (let k in this.printBuffer) {
                        this.printBuffer[k].destroy();
                    }
                },
                clearAll() {
                    this.clearPrints();
                },
                display() {
                    for (let p of Object.values(this.printBuffer)) {
                        print(p.x,p.y,p.text,p.baseColor,p.nlindent);
                        //console.log('displaying '+JSON.stringify(line.text)+' @'+i)
                    }
                },
                disable() {
                    this._enabled = false;
                },
                printBuffer: {}
            }

            const vconsole = {
                print: function(text,b=true) {
                    let l = ""+Math.random();
                    let ret = {
                        text,
                        destroy: function() {
                            delete vconsole.lines[this.key];
                            return undefined;
                        },
                        lines:(text.match(/\n/g)??[]).length+1,b,
                        key:l
                    }
                    this.lines[l] = ret;
                    return ret;
                },
                inputValue:'',
                input: function(prompt='',modify=function(val){return val},modifyEnd=modify) {
                    let press = [];
                    let baseText = prompt;
                    let txt = vconsole.print(baseText,b=false);
                    let input = '';
                    let done = false;
                    clock.submit(function(){
                        for (let i=0; i<26; i++) {
                            for (let b of [65,97]) {
                                let char = String.fromCharCode(i+b);
                                if (pressed.indexOf(char)!=-1) {
                                    if (press.indexOf(char)==-1) {
                                        press.push(char);
                                        input += char;
                                    }
                                } else {
                                    press = press.filter(k=>k!=char);
                                }
                            }
                        }
                        for (let c of ' :;,._\\|+-*/()[]{}0123456789\'"!?^$@#%Â°&') {
                            if (getPressed(c)) {
                                input += c;
                            }
                        }
                        if (getPressed('Backspace')) {
                            input = input.slice(0,input.length-1);
                        }
                        if (getPressed('Enter') || getPressed('Return')) {
                            txt.text = baseText+modifyEnd(input);
                            this.unsubmit();
                            done = true;
                        }
                        txt.text = baseText+modify(input);
                        vconsole.inputValue = input;
                    });
                    return ()=>done;
                },
                clearLine: function() {
                    if (Object.keys(this.lines).length>0) {
                        this.lines[Object.keys(this.lines).reverse()[0]].destroy();
                    }
                },
                clear: function() {
                    for (let linn of Object.keys(this.lines)) {
                        this.lines[linn].destroy();
                    }
                },
                display: function() {
                    let i = 0;
                    for (let line of Object.values(this.lines)) {
                        print(1,(CES.showTitle?20:5)+i*11,(line.b?'> ':'')+line.text,'#ffffff',2);
                        //console.log('displaying '+JSON.stringify(line.text)+' @'+i)
                        i+=line.lines;
                    }
                },
                lines: {}
            }

            function mod(n,m){return((n%m)+m)%m}

            function drawPixel(x,y,color='#ffffff') {
                //console.log('YYY ',x,y,color);
                ctx.fillStyle = color;//'rgb(255,255,255)';
                ctx.fillRect(x*screenCfg.pixelSize,y*screenCfg.pixelSize,screenCfg.pixelSize,screenCfg.pixelSize);
            }

            function drawImage(x,y,data,scale=1) {
                let sx = 0,
                    sy = 0;
                for (let l of data) {
                    for (var _=0;_<scale;_++) {
                        sx = 0;
                        for (let p of l) {
                            for (var __=0;__<scale;__++) {
                                if(p)drawPixel(sx+x,sy+y,p);
                                sx++
                            }
                        }
                        sy++
                    }
                }
            }

            function lerp1(x,y,t) { return (1-t)*x+t*y; }

            function lerp2(p1,p2,t) {
                let x1 = p1[0]; let x2 = p2[0];
                let y1 = p1[1]; let y2 = p2[1];

                return [
                    // x1*(1-x2)+x2*t,
                    // y1*(1-y2)+y2*t,
                    lerp1(x1,x2,t),
                    lerp1(y1,y2,t)
                ]
            }

            function drawLine(x1,y1,x2,y2,color='#ffffff') {
                let step = 1/((Math.abs(x1-x2)**2+Math.abs(y1-y2)**2)**.5);
                let t = 0;
                while (true) {
                    let lerpPos = lerp2([x1,y1],[x2,y2],t);
                    drawPixel(Math.round(lerpPos[0]),Math.round(lerpPos[1]),color);
                    t += step;
                    if (t>1) break;
                }
            }

            function printChar(x,y,char,color='#ffffff') {
                let chars = {
                    'a': [[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4],[4,4]],
                    'b': [[0,-2],[0,-1],[0,0],[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4]],
                    'c': [[1,0],[2,0],[3,0],[4,0],[0,1],[0,2],[0,3],[1,4],[2,4],[3,4],[4,4]],
                    'd': [[4,-2],[4,-1],[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4],[4,4]],
                    'e': [[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,4],[2,4],[3,4],[4,4]],
                    'f': [[2,-1],[3,-1],[1,0],[4,0],[1,1],[0,2],[1,2],[2,2],[3,2],[1,3],[1,4]],
                    'g': [[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4],[4,4],[4,5],[1,6],[2,6],[3,6]],
                    'h': [[0,-2],[0,-1],[0,0],[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[4,4]],
                    'i': '[[2,-1],[1,1],[2,1],[2,2],[2,3],[1,4],[2,4],[3,4]]', //[[2,0],[1,2],[2,2],[2,3],[1,4],[2,4],[3,4]],
                    'j': [[4,0],[4,2],[4,3],[4,4],[0,5],[4,5],[1,6],[2,6],[3,6]],
                    'k': [[0,-2],[0,-1],[0,0],[4,0],[0,1],[3,1],[0,2],[1,2],[2,2],[0,3],[3,3],[0,4],[4,4]],
                    'l': [[1,-1],[2,-1],[2,0],[2,1],[2,2],[2,3],[1,4],[2,4],[3,4]], //[[0,-1],[0,0],[0,1],[0,2],[0,3],[1,4],[2,4],[3,4],[4,4]], //[[0,-1],[0,0],[0,1],[0,2],[1,3],[2,4],[3,4],[4,4]],//[[1,-1],[1,0],[1,1],[1,2],[1,3],[2,4],[3,4]],
                    'm': [[0,0],[1,0],[2,0],[3,0],[0,1],[2,1],[4,1],[0,2],[2,2],[4,2],[0,3],[2,3],[4,3],[0,4],[2,4],[4,4]],
                    'n': [[0,0],[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[4,4]],
                    'o': [[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]],
                    'p': [[0,0],[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[0,5],[0,6]],
                    'q': [[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4],[4,4],[4,5],[4,6]],
                    'r': [[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[0,3],[0,4]],
                    's': [[1,0],[2,0],[3,0],[4,0],[0,1],[1,2],[2,2],[3,2],[4,3],[0,4],[1,4],[2,4],[3,4]],
                    't': [[1,-2],[1,-1],[0,0],[1,0],[2,0],[3,0],[1,1],[1,2],[1,3],[2,4],[3,4],[4,4]],
                    'u': [[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]],
                    'v': [[0,0],[4,0],[0,1],[4,1],[1,2],[3,2],[1,3],[3,3],[2,4]],
                    'w': [[0,0],[4,0],[0,1],[4,1],[0,2],[2,2],[4,2],[0,3],[2,3],[4,3],[1,4],[3,4]],
                    'x': [[0,0],[4,0],[1,1],[3,1],[2,2],[1,3],[3,3],[0,4],[4,4]],
                    'y': [[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4],[4,4],[4,5],[1,6],[2,6],[3,6]],

                    A: '[[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[4,3],[0,4],[4,4]]',
                    B: '[[0,-2],[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[1,1],[2,1],[3,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4]]',
                    C: '[[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[0,1],[0,2],[0,3],[4,3],[1,4],[2,4],[3,4]]',
                    D: '[[0,-2],[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4]]',
                    E: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[0,-1],[0,0],[0,1],[1,1],[2,1],[3,1],[0,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    F: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[0,-1],[0,0],[0,1],[1,1],[2,1],[3,1],[0,2],[0,3],[0,4]]',
                    G: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[0,-1],[0,0],[0,1],[3,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    H: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[4,4]]',
                    I: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[2,-1],[2,0],[2,1],[2,2],[2,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    J: '[[2,-2],[3,-2],[4,-2],[4,-1],[4,0],[4,1],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]]',
                    K: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[3,0],[0,1],[1,1],[2,1],[0,2],[3,2],[0,3],[4,3],[0,4],[4,4]]',
                    L: '[[0,-2],[0,-1],[0,0],[0,1],[0,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    M: '[[0,-2],[4,-2],[0,-1],[1,-1],[3,-1],[4,-1],[0,0],[2,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[4,4]]',
                    N: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[1,0],[4,0],[0,1],[2,1],[4,1],[0,2],[3,2],[4,2],[0,3],[4,3],[0,4],[4,4]]',
                    O: '[[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]]',
                    P: '[[0,-2],[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[1,1],[2,1],[3,1],[0,2],[0,3],[0,4]]',
                    Q: '[[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[2,3],[4,3],[1,4],[2,4],[3,4],[3,5],[4,5]]',
                    R: '[[0,-2],[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[1,1],[2,1],[3,1],[0,2],[2,2],[0,3],[3,3],[0,4],[4,4]]',
                    S: '[[1,-2],[2,-2],[3,-2],[0,-1],[4,-1],[0,0],[1,1],[2,1],[3,1],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]]',
                    T: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[2,-1],[2,0],[2,1],[2,2],[2,3],[2,4]]',
                    U: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[1,4],[2,4],[3,4]]',
                    V: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[4,0],[1,1],[3,1],[1,2],[3,2],[1,3],[3,3],[2,4]]',
                    W: '[[0,-2],[4,-2],[0,-1],[4,-1],[0,0],[4,0],[0,1],[2,1],[4,1],[0,2],[2,2],[4,2],[0,3],[2,3],[4,3],[1,4],[3,4]]',
                    X: '[[0,-2],[4,-2],[0,-1],[4,-1],[1,0],[3,0],[2,1],[1,2],[3,2],[0,3],[4,3],[0,4],[4,4]]',
                    Y: '[[0,-2],[4,-2],[0,-1],[4,-1],[1,0],[3,0],[2,1],[2,2],[2,3],[2,4]]',
                    Z: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[4,-1],[3,0],[2,1],[1,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',

                    '+': '[[2,0],[2,1],[0,2],[1,2],[2,2],[3,2],[4,2],[2,3],[2,4]]',//'[[2,1],[1,2],[2,2],[3,2],[2,3]]',
                    '-': '[[0,2],[1,2],[2,2],[3,2],[4,2]]', //'[[1,2],[2,2],[3,2]]',
                    '/': '[[4,0],[3,1],[2,2],[1,3],[0,4]]', //'[[3,1],[2,2],[1,3]]',
                    '*': '[[1,0],[3,0],[2,1],[1,2],[2,2],[3,2],[2,3],[1,4],[3,4]]',
                    '=': '[[1,1],[2,1],[3,1],[1,3],[2,3],[3,3]]',

                    '0': '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[3,1],[4,1],[0,2],[2,2],[4,2],[0,3],[1,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '1': '[[2,0],[1,1],[2,1],[2,2],[2,3],[1,4],[2,4],[3,4]]',
                    '2': '[[0,0],[1,0],[2,0],[3,0],[4,0],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '3': '[[0,0],[1,0],[2,0],[3,0],[4,0],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '4': '[[0,0],[4,0],[0,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[4,3],[4,4]]',
                    '5': '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[0,2],[1,2],[2,2],[3,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '6': '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '7': '[[0,0],[1,0],[2,0],[3,0],[4,0],[4,1],[3,2],[2,3],[1,4]]',
                    '8': '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    '9': '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',

                    '.': '[[2,4]]',
                    ',': '[[2,4],[1,5]]',
                    '!': '[[2,-2],[2,-1],[2,0],[2,1],[2,2],[2,4]]',
                    ':': '[[2,1],[2,3]]',
                    ';': '[[2,1],[2,3],[1,4]]',
                    '?': '[[2,-1],[3,-1],[1,0],[4,0],[4,1],[3,2],[3,4]]',
                    "'": '[[2,-2],[2,-1]]',
                    '<': '[[3,0],[2,1],[1,2],[2,3],[3,4]]',
                    '>': '[[1,0],[2,1],[3,2],[2,3],[1,4]]',
                    '\\': '[[0,0],[1,1],[2,2],[3,3],[4,4]]', //'[[1,1],[2,2],[3,3]]',
                    '|': '[[2,0],[2,1],[2,2],[2,3],[2,4]]', //'[[2,1],[2,2],[2,3]]', 
                    '"': '[[1,-2],[3,-2],[1,-1],[3,-1]]',
                    '{': '[[3,-2],[2,-1],[2,0],[1,1],[2,2],[2,3],[3,4]]',
                    '}': '[[1,-2],[2,-1],[2,0],[3,1],[2,2],[2,3],[1,4]]',
                    '(': '[[2,-2],[1,-1],[1,0],[1,1],[1,2],[1,3],[2,4]]',
                    ')': '[[2,-2],[3,-1],[3,0],[3,1],[3,2],[3,3],[2,4]]',
                    '[': '[[1,-2],[2,-2],[3,-2],[1,-1],[1,0],[1,1],[1,2],[1,3],[1,4],[2,4],[3,4]]',
                    ']': '[[1,-2],[2,-2],[3,-2],[3,-1],[3,0],[3,1],[3,2],[3,3],[1,4],[2,4],[3,4]]',

                    block: '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    upperBlock: '[[0,-2],[1,-2],[2,-2],[3,-2],[4,-2],[0,-1],[1,-1],[2,-1],[3,-1],[4,-1],[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]]',
                    lowerBlock: '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4],[0,5],[1,5],[2,5],[3,5],[4,5],[0,6],[1,6],[2,6],[3,6],[4,6]]',
                    fullBlock: '[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4],[0,5],[1,5],[2,5],[3,5],[4,5],[0,6],[1,6],[2,6],[3,6],[4,6]]',

                    _: '[[0,5],[1,5],[2,5],[3,5],[4,5]]',
                    '^': '[[2,-1],[1,0],[3,0],[0,1],[4,1]]',
                    '$': '[[2,-1],[1,0],[2,0],[3,0],[4,0],[0,1],[2,1],[1,2],[2,2],[3,2],[2,3],[4,3],[0,4],[1,4],[2,4],[3,4],[2,5]]',
                    '%': '[[4,0],[0,1],[3,1],[2,2],[1,3],[4,3],[0,4]]',
                    'Â°': '[[2,-1]]',
                    '#': '[[1,0],[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[3,2],[0,3],[1,3],[2,3],[3,3],[4,3],[1,4],[3,4]]',       
                    '@': '[[1,0],[2,0],[3,0],[0,1],[4,1],[0,2],[3,2],[4,2],[0,3],[1,4],[2,4],[3,4],[4,4]]',
                    heart: '[[1,0],[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[1,3],[2,3],[3,3],[2,4]]',
                    '&': '[[1,0],[2,0],[1,1],[0,2],[2,2],[4,2],[0,3],[3,3],[0,4],[1,4],[2,4],[4,4]]',

                    //       [1,1],[3,1],
                    // [0,2],      [3,2],
                    // [0,3],      [3,3],
                    //       [1,4],[3,4],
                    // [0,0],
                    // [0,1],[1,1],[2,1],
                    // [0,2],            [3,2],
                    // [0,3],            [3,3],
                    // [0,4],[1,4],[2,4],
                    // 'c':[
                      
                    //         [1,1],[2,1],
                    //     [0,2],
                    //     [0,3],
                    //         [1,4],[2,4],
                    // ],
                    // 'd':[
                    //                 [2,0],
                    //           [1,1],[2,1],
                    //     [0,2],      [2,2],
                    //     [0,3],      [2,3],
                    //           [1,4],[2,4],
                    // ],
                    // 'l': [
                    //     [1,0],[2,0],
                    //           [2,1],
                    //           [2,2],
                    //           [2,3],
                    //     [1,4],[2,4],[3,4]
                    // ]
                }

                for (let k in chars) {
                    if (typeof(chars[k]) == 'string') {
                        chars[k] = eval(chars[k]);
                    }
                }

                let c = chars[char]??[];

                if (c) {
                    for (px of c.map(e=>[e[0]+x,e[1]+y])) {
                        //console.log('EEE ',color,px[0],px[1]+2);
                        drawPixel(px[0],px[1]+2,color);
                    }
                }
            }

            function print(x,y,text,color='#ffffff',nlindent=0) {
                let originColor = color;
                let underline = false;
                let skip = 0;
                let i = 0;
                for (let ci in text) {
                    ci = Number(ci);
                    let c = text[ci];
                    if (skip!=0) {
                        skip--;
                        continue;
                    }
                    //console.log(c,text[ci+1])
                    if (c == '^' && text[ci+1]=='[') {
                        //console.log('HMMM')
                        let ctrlend = text.indexOf(']',ci);
                        if (ctrlend!=-1) {
                            skip = ctrlend-ci;
                            for (let idk of text.slice(ci+2,ctrlend).split(/;/g)) {
                                if (idk=='red') { color = '#ff0000' } else
                                if (idk=='green') { color = '#00ff00' } else
                                if (idk=='blue') { color = '#0000ff' } else
                                if (idk=='yellow') { color = '#ffff00' } else
                                if (idk=='cyan') { color = '#00ffff' } else
                                if (idk=='white') { color = '#ffffff' } else
                                if (idk=='lightGray'||idk=='lightGrey') { color = '#b0b0b0' } else
                                if (idk=='gray'||idk=='grey') { color = '#808080' } else
                                if (idk=='darkGray'||idk=='darkGrey') { color = '#404040' } else
                                if (idk=='black'||idk=='black') { color = '#000000' } else
                                if (idk=='reset') { color = originColor, underline = false } else
                                if (idk=='underline') { underline = !underline } else
                                {

                                }
                            }
                        }
                        continue;
                    }
                    if (c=='$'&&text[ci+1]=='[') {
                        let ctrlend = text.indexOf(']',ci);
                        if (ctrlend!=-1) {
                            skip = ctrlend-ci;
                            for (let idk of text.slice(ci+2,ctrlend).split(/;/g)) {
                                printChar(x+i*6,y,idk,color);
                            }
                        }
                        continue;
                    }
                    if (c=='\n') {
                        i=nlindent;y+=11;continue
                    }
                    //console.log(skip);
                    printChar(x+i*6,y,c,color);
                    //console.log('AAA ',c);
                    if (underline) {
                        // for (let xx=0; xx<6; xx++) {
                        //     drawPixel(x+i*6+xx,y+9,color);
                        // }
                        drawLine(x+i*6,y+9,x+i*6+6,y+9,color)
                    }
                    i++;
                }
                // for (let ci in text) {
                //     let c = text[ci];
                //     printChar(x+ci*6,y,c,color);
                // }
            }

            let loadstate = ['/','-','\\','|'];
            let ii = 0;

            let loadtext = vconsole.print('');
            let loadtime = 0;
            let maxloadtime = Math.round(Math.random()*3);

            function drawLoop() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                // for (px of [
                //     [0,0],[1,0],
                //           [1,1],
                //           [1,2],
                //           [1,3],
                //     [0,4],[1,4],[2,4]
                // ]) {
                //     drawPixel(px[0],px[1])
                // }
                //printChar(0,0,'h'); printChar(6,0,'a');  printChar(12,0,'c'); printChar(18,0,'k'); printChar(24,0,''); printChar(30,0,'n');
                //print(0,1, '            Carte d\'invitation');
                if (CES.showTitle) print(1,1,'^[yellow]CES^[reset]    ^[underline]Chicken Entertainment System^[reset]');

                if (loadtime>=maxloadtime) {loadtext.destroy()}
                if (loadtime<maxloadtime) {loadtext.text = 'loading... '+loadstate[ii]; ii++; ii%=loadstate.length;}
                loadtime++;
                
                vconsole.display();
                CES.display();

                if (!CES._enabled) clearInterval(drawLoopId);
            }
            let drawLoopId = setInterval(drawLoop,10);

            async function waitFor(fn) {

                return new Promise((resolve)=>{
                    let loop = setInterval(()=>{
                        if (fn()) {
                            clearInterval(loop);
                            resolve();
                            return;
                        }
                    });
                });

            }

            async function waitForLoadEnded() {

                // return new Promise((resolve)=>{
                //     let loop = setInterval(()=>{
                //         if (loadtime>=maxloadtime) {
                //             clearInterval(loop);
                //             resolve();
                //         }
                //     });
                // });

                return waitFor(()=>loadtime>=maxloadtime);

            }

            const clock = {
                tick: function() {
                    for (let cb of this.callbacks) {
                        cb.call({
                            unsubmit: function() { clock.unsubmit(cb) }
                        });
                    }
                },
                callbacks: [],
                submit: function(callback) {
                    if(this.callbacks.indexOf(callback)==-1)this.callbacks.push(callback);
                },
                unsubmit: function(callback) {
                    this.callbacks = this.callbacks.filter(c=>c!=callback);
                }
            }
            setInterval(()=>clock.tick(),10);

            let pressed = [];
            let pressedBefore = [];
            document.addEventListener('keydown',(ev)=>{
                if(pressed.indexOf(ev.key)==-1)pressed.push(ev.key);
            });
            document.addEventListener('keyup',(ev)=>{
                pressed = pressed.filter(k=>k!=ev.key);
            });
            setInterval(function(){
                pressedBefore = JSON.parse(JSON.stringify(pressed));
            },10);
            function getPressed(key) {
                return (pressed.indexOf(key)!=-1)&&( (pressed.indexOf(key)!=-1)^(pressedBefore.indexOf(key)!=-1) )
            }

            let progs = {};
            let prognames = {};
            function addProgram(name,callback,displayName=undefined) {
                displayName??=name;
                progs[name] = callback;
                prognames[name] = displayName;
            }

            function runProgram(programName) {
                progs[programName]();
            }

            waitForLoadEnded().then(()=>{
                runProgram('main');
            });
        </script>

        <script>
            addProgram('desktop',async()=>{
                CES.showTitle = false;
                CES.clearAll();
                vconsole.clear();
                vconsole.print('loading...');
                CES.disable();
                screenCfg.setPixelSize(2);
                canvas.style.backgroundColor = 'rgb(0, 0, 0)';

                let files = [
                    {x:0,y:0,name:'a.txt'},
                    {x:0,y:1,name:'b'},
                    {x:1,y:2,name:'c.bin'},
                ]
                let icons = await fetch('./icons.json').then(r=>r.json());
                let fileIcons = icons.file;

                function displayfileIcon(x,y,name) {
                    let icon;
                    if (name.endsWith('.txt')) {
                        icon = fileIcons.txt;
                    } else if (name.endsWith('.bin')) {
                        icon = fileIcons.bin;
                    } else {
                        icon = fileIcons.unknown;
                    }
                    drawImage(x*50+10,y*50+10,icon,2);
                    print(50*(x+1)-30-(5*name.length/2),50*(y+1)-7,name);
                }
                
                function displayDesktopFilesIcons() {
                    for (let file of files) {
                        displayfileIcon(file.x,file.y,file.name);
                    }
                }

                function displayDesktopContextMenu(x,y) {
                    //drawImage(x,y,)
                    //print(x+1,y+1,'New file');
                }

                let md=0;
                let mx=0;
                let my=0;
                canvas.onmousedown = (e)=>{md=e.buttons};
                canvas.onmouseup   = (e)=>{md=e.buttons};
                canvas.onmousemove = (e)=>{mx=e.offsetX/screenCfg.pixelSize;my=e.offsetY/screenCfg.pixelSize};
                let lx;
                let ly;
                let pp = false;
                let dcmx,dcmy;
                let ddcm = false;
                clock.submit(function(){
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    displayDesktopFilesIcons();
                    if (ddcm) {
                        displayDesktopContextMenu(dcmx,dcmy);
                    }
                    if ((md&2)&&!pp) {
                        ddcm = !ddcm;
                        dcmx = mx;
                        dcmy = my;
                    }
                    if (md&2) {
                        pp = true;
                    } else {
                        pp = false;
                    }
                });
            });
        </script>

        <script>
            let choiceIndex = 0;

            let links = {
                '3d Renderer': 'https://chickchicky.github.io/3D_renderer',
                'TCCL IDE': 'https://chickchicky.github.io/tccl_IDE',
                'Tetris for CC-Tweaked': 'https://github.com/ChickChicky/CC_Tetris',
                'Virtual copmuter and processor': 'https://github.com/ChickChicky/nugget-computer',
                'Huffman coding compressor': 'https://github.com/ChickChicky/JS_compressor',
                'Serial Communication test': 'https://github.com/ChickChicky/serial-com',
                'Standing waves (numworks.com)': 'https://numworks.com/python/chick-chicky/wavez'
            }

            addProgram('main',()=>{
                CES.showTitle = true;
                CES.clearAll();
                vconsole.clear();
                vconsole.print('Select a program to run:');
   let choice = vconsole.print(Object.keys(links).join('\n'));
                vconsole.print('(use arrow keys)');
                
                let press = false;
                let done = false;

                clock.submit(function(){
                    // if (pressed.indexOf('ArrowUp')!=-1) {
                    //     if (!press) { choiceIndex -= 1;
                    //                   press = true;     }
                    // } else
                    // if (pressed.indexOf('ArrowDown')!=-1) {
                    //     if (!press) { choiceIndex += 1;
                    //                   press = true;     }
                    // } else { press = false; }
                    // if (pressed.indexOf('Enter')!=-1) {
                    //     done = true;
                    //     this.unsubmit();
                    // }
                    if (getPressed('ArrowUp')) {
                        choiceIndex -= 1;
                    }
                    if (getPressed('ArrowDown')) {
                        choiceIndex += 1;
                    }
                    if (getPressed('Enter')) {
                        done = true;
                        this.unsubmit();
                    }

                    choiceIndex = mod(choiceIndex,Object.keys(links).length);
                    choice.text = Object.keys(links).map((c,i)=>((choiceIndex==i)?'^[red]* ':'')+c+'^[reset]').join('\n')
                });

                waitFor(()=>done).then(()=>{
                    window.location.href = Object.values(links)[choiceIndex];
                });
            });
        </script>

        <!--
        <script>
            addProgram('REPL',()=>{setTimeout(()=>{
                // vconsole.clear();
                // CES.showTitle = false;
                // let offlineText = '^[underline]offline';
                // screenCfg.setScreenSize(50)
                // CES.print(4,15,offlineText);
                
                CES.showTitle = true;
                CES.clearAll();
                vconsole.clear();
                vconsole.print('CES console',false);

                async function input(prompt,modifier) {

                    return new Promise(async(resolve)=>{
                        await waitFor(vconsole.input(prompt,modifier));
                        resolve(vconsole.inputValue);
                    });

                }

                let commandNames = [
                    'echo'
                ]

                let commandExecutors = {
                    'echo': function(params,rawParams) {
                        let times = 1
                        if ((params[0]??'').match(/^\d+$/)) {
                            times = Number(params[0]);
                            rawParams = rawParams.slice(params[0].length+1);
                        }
                        rawParams.replace(/(?<!\\)\\n/g,'\n');
                        rawParams.replace(/\\\\/g,'\\');
                        vconsole.print(rawParams.repeat(times));
                    }
                }

                ;(async()=>{while(true){

                    let inpu = await input('>>> ',(val)=>{
                        let s = 0;
                        return val.split(' ').map((word,i)=>{
                            i = +i;
                            if (word=='&&') {
                                s = i+1;
                            }
                            return (((i-s)==0)?((commandNames.indexOf(word)!=-1)?'^[yellow]':'^[underline;red]'):((word.match(/^\d+$/))?'^[green]':((word.startsWith('-'))?'^[gray]':((word=='&&')?'^[blue]':''))))+word+'^[reset]';
                        }).join(' ');
                    },(val)=>{return val});

                    for (let inp of inpu.split(/\s&&\s/g)) {
                        let [cmd,...args] = (inp+' ').split(' ');
                        cmd = cmd.trim(); args = args.join(' ').trim();

                        if (commandNames.indexOf(cmd)!=-1) {
                            commandExecutors[cmd](args.split(/\s+/g),args); 
                        } else {
                            vconsole.print('^[red]unknown command ('+cmd+')');
                        }
                    }

                    //vconsole.print(inp);
                    

                }})();
            },1)},'start REPL');
        </script>

        <script>
            addProgram('test',()=>{
                CES.showTitle = false;
                vconsole.clear();
                vconsole.print('Hello, world !');
                setTimeout(()=>{
                    clock.submit(function(){
                        if (pressed.length>0) {
                            this.unsubmit();
                            runProgram('main');
                        }
                    });
                    vconsole.print('[press any key to exit]');
                },100)
            });
        </script>
        -->

    </body>

</html>